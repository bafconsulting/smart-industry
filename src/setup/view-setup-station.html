<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../view-index.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="view-setup-station">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        --app-grid-item-height: 50%;
      }
      
       @media (min-width: 360px) and (max-width: 768px) {
         :host {
          --app-grid-columns: 1;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
         :host {
          --app-grid-columns: 2;
        }
      }

      @media (min-width: 1025px) and (max-width: 1200px) {
         :host {
          --app-grid-columns: 3;
        }
      }
       @media (min-width: 1201px) and (max-width: 2560px) {
         :host {
          --app-grid-columns: 4;
        }
      }

      .station-dialog {
        width: 35%;
        padding: 10px;
      }
      .station-dialog {
        padding-top: 40px;
      }
     .station { 
      min-height: 250px;
      height: auto; 
      }
     .station p {
        margin: 12px 0;
      }
     .station h1 { text-align: center; }
     .station-info-group {
       margin-bottom: auto;
     }
     .station-title {
       font-size: 2rem;
     }
     .button-group paper-button {
       width: 49%;
       padding: 10px;
     }
    .no-machine-title {
        font-size: 2rem;
        font-weight: 400;
        text-align: center;
        padding: 30px 0;
      }
    </style>
    <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
    <firebase-query app-name="smart-mes" id="stationQuery" path="/station" order-by-child="name" order-by-value="true" data="{{stationItems}}"></firebase-query>
    <firebase-query app-name="smart-mes" id="machineQuery" path="/machine" order-by-child="station" data="{{machineItems}}"></firebase-query>
    <firebase-document app-name="smart-mes" id="appNotification" path="/metadata/appNotification" data="{{notification}}"></firebase-document>
    <firebase-document app-name="smart-mes" id="appLanguage" path="/metadata/appLanguage" data="{{language}}"></firebase-document>
    <app-localstorage-document key="lang" data="{{language}}"></app-localstorage-document>
    <app-indexeddb-mirror key="machineDataCache" data="{{machineItems}}" persisted-data="{{persistedMachineData}}"></app-indexeddb-mirror>
    <app-indexeddb-mirror key="stationDataCache" data="{{stationItems}}" persisted-data="{{persistedStationData}}"></app-indexeddb-mirror>
    <div class="stitched">
          <h1 class="no-machine-title" hidden$="[[machineItems]]">Please add machine before adding station.</h1>
          <paper-button raised on-tap="toggleDialog" class="big-btn fancy" hidden$="[[!machineItems]]"><iron-icon icon="vaadin:plus"></iron-icon> {{localize('add-station')}}</paper-button>
          <paper-dialog id="createStationDialog" class="station-dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" always-on-top
            no-cancel-on-outside-click>
            <h1>{{localize('add-station')}}</h1>
            <paper-input type="number" id="stationNumber" name="station-number" label="{{localize('station-number')}}" value="[[getStationNumber(stationItems.length)]]" min="1" max="999" step="1" disabled="true" required always-float-label></paper-input>
            <paper-input type="text" id="stationName" name="station-name"  label="{{localize('station-name')}}" required always-float-label></paper-input>
            <vaadin-combo-box label="Machine" id="machineNumber" items="[[persistedMachineData]]" name="stationName" item-label-path="name" selected-item="{{mdata}}" required always-float-label></vaadin-combo-box>        
            <paper-button on-tap="addMachineToStation">Add Machine</paper-button>
            <div role="listbox">
            <template is="dom-repeat" items="{{stationMachine}}" as="stationMachine">
               <paper-item>[[stationMachine.name]]</paper-item>
            </template>
            </div>
           <div class="buttons">
                <paper-button on-tap="dismissAddStation" dialog-dismiss>{{localize('dismiss')}}</paper-button>
                <paper-button on-tap="addStation" dialog-confirm autofocus>{{localize('add')}}</paper-button>
              </div>
        </paper-dialog>
    </div>
    <ul class="app-grid" hidden$="[[!machineItems]]">
      <template is="dom-repeat" items="{{persistedStationData}}" as="stationItem">
        <li>  
            <div class="card station">
            <div class="station-info-group">
            <h1 class="station-title">[[stationItem.name]]</h1>
            <p>{{localize('station-number')}}: [[stationItem.number]]</p>
            <p>{{localize('station-name')}}: [[stationItem.name]]</p>
            <p>{{localize('station-machine')}}: [[stationItem.machine]]</p> 
            </div>
            <div class="button-group">
            <paper-button raised class="fancy" station="[[stationItem]]" on-tap="editStation">{{localize('edit')}}</paper-button>
            <paper-button raised class="chilli" station="[[stationItem]]" on-tap="removeStation">{{localize('remove')}}</paper-button>
            </div>
            <paper-dialog id="edit_[[stationItem.$key]]" class="station-dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" always-on-top no-cancel-on-outside-click>
            <h2>{{localize('edit-station')}}</h2>
            <paper-input type="number" id="number_[[stationItem.$key]]" name="station-number" class="editstationNumber" value="[[stationItem.number]]" label="{{localize('station-number')}}" min="1" max="999" step="1" disabled="true" required always-float-label></paper-input>
            <paper-input type="text" id="name_[[stationItem.$key]]" name="station-name" class="editstationName" value="[[stationItem.name]]" label="{{localize('station-name')}}" required always-float-label></paper-input>
             <div class="buttons">
                <paper-button station="[[stationItem]]" dialog-dismiss>{{localize('dismiss')}}</paper-button>
                <paper-button station="[[stationItem]]" on-tap="saveEditStation" dialog-confirm autofocus>{{localize('save')}}</paper-button>
            </div>
            </paper-dialog>
          </div>
        </li>
      </template>
    </ul>
  <paper-toast id="toastAddStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-add-station')}}"></paper-toast>
  <paper-toast id="toastSaveStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-save-station')}}"></paper-toast>
  <paper-toast id="toastDeleteStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-delete-station')}}"></paper-toast>
  <paper-toast id="toastEmptyAddStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-empty-add-station')}}"></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'view-setup-station',
      properties: {
        stationItems: {
          type: Object
        },
        machineItems: {
          type: Object
        },
        notification: {
          type: Object
        },
        stationMachine: {
          type: Array,
          value: []
        }
      },
      behaviors: [
        Polymer.AppLocalizeBehavior,
        Polymer.AppLanguageBehavior
      ],
      attached: function() {
         this.loadResources(this.resolveUrl('../../data/locales.json'));
      },
      toggleDialog() {
        this.$.createStationDialog.open();
      },
      getStationNumber(length) {
        if(length == 0) {
          return 1;
        } else {
          return length+1;
        }
      },
      addStation() {
        let sname = this.$.stationName.value;
        let snumber = this.$.stationNumber.value;
        let smachine = this.stationMachine;
        if(sname !== "" && snumber !== "") {
        this.$.stationQuery.ref.push({
          name : sname,
          number : snumber,
          machine : smachine
        });
        this.clearField();
           this.$.toastAddStation.open(); 
        } else {
          this.$.toastEmptyAddStation.open();
        }
      },
      editStation(e) {
        let key = e.currentTarget.station.$key;
        this.$$('#edit_'+ key).open();  
      },
      removeStation(e) {
         if (confirm("Delete tihs station ?") == true) { 
           let key = e.currentTarget.station.$key;
           this.$.stationQuery.ref.child(key).remove();
        if(this.notification) {
        this.$.toastDeleteStation.open(); 
         }
        } else {}  
      },
      saveEditStation(e) {
        let key = e.currentTarget.station.$key;
        let sname = this.$$('#name_' + key).value;
        let snumber = this.$$('#number_' + key).value;
        if(sname !== "" && snumber !== "") {
         this.$.stationQuery.ref.child(key).set({
            name: sname,
            number: snumber
        });
           this.$$('.station-dialog').close();
           this.$.toastSaveStation.open();
         } else {
            this.$.toastEmptyAddStation.open();
        }
      },
      // check machine station equal to station number then return machine name
      addMachineToStation() {
        if(this.stationMachine.length > 10) {
          alert("Can't add more than 10 machines to station");
        } else {
         
          this.stationMachine.push(this.$.machineNumber.value);
          console.log(this.stationMachine);
        }
      },

      dismissEditStation(e) {
        let key = e.currentTarget.station.$key;
      },

      dismissAddStation() {
        this.clearField();
        this.$.createStationDialog.cancel();
      },

      clearField() {
        this.$.stationName.value = "";
        this.$.stationNumber.value = this.stationItems.length + 1;
      },

    });
  </script>
</dom-module>