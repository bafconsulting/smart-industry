<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../view-index.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="view-setup-station">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        --app-grid-item-height: 50%;
      }
      
       @media (min-width: 360px) and (max-width: 768px) {
         :host {
          --app-grid-columns: 1;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
         :host {
          --app-grid-columns: 2;
        }
      }

      @media (min-width: 1025px) and (max-width: 1200px) {
         :host {
          --app-grid-columns: 3;
        }
      }
       @media (min-width: 1201px) and (max-width: 2560px) {
         :host {
          --app-grid-columns: 4;
        }
      }

      .station-dialog {
        width: 35%;
        padding: 10px;
      }
     .station { min-height: 250px; height: auto; }
     .station p {
        margin: 12px 0;
      }
     .station h1 { text-align: center; }
     .station-info-group {
       margin-bottom: auto;
     }
     .station-title {
       font-size: 2rem;
     }
     .button-group paper-button {
       width: 49%;
       padding: 10px;
     }
    </style>
    <firebase-query app-name="smart-mes" id="stationQuery" path="/station" order-by-child="name" order-by-value="true" data="{{stationItems}}"></firebase-query>
    <firebase-document app-name="smart-mes" id="appNotification" path="/metadata/appNotification" data="{{notification}}"></firebase-document>
    <firebase-document app-name="smart-mes" id="appLanguage" path="/metadata/appLanguage" data="{{language}}"></firebase-document>
    <app-localstorage-document key="lang" data="{{language}}"></app-localstorage-document>
    <app-indexeddb-mirror key="stationDataCache" data="{{stationItems}}" persisted-data="{{persistedStationData}}" session="[[user.uid]]"></app-indexeddb-mirror>
    <div class="stitched">
          <paper-button raised on-tap="toggleDialog" class="big-btn fancy"><iron-icon icon="vaadin:plus"></iron-icon> {{localize('add-station')}}</paper-button>
          <paper-dialog id="createStationDialog" class="station-dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" always-on-top
            no-cancel-on-outside-click>
            <h1>{{localize('add-station')}}</h1>
            <paper-input type="text" id="stationName" name="station-name"  label="{{localize('station-name')}}" required always-float-label></paper-input>
            <paper-input type="number" id="stationNumber" name="station-number" label="{{localize('station-number')}}" value="[[getStationNumber(stationItems.length)]]" min="1" max="99" step="1" required always-float-label></paper-input>
            <div class="buttons">
                <paper-button on-tap="dismissAddStation" dialog-dismiss>{{localize('dismiss')}}</paper-button>
                <paper-button on-tap="addStation" dialog-confirm autofocus>{{localize('create')}}</paper-button>
              </div>
            </paper-dialog>
    </div>
    <ul class="app-grid">
      <template is="dom-repeat" items="{{persistedStationData}}" as="stationItem">
        <li>  
            <div class="card station">
            <div class="station-info-group">
            <h1 class="station-title">[[stationItem.name]]</h1>
            <p>{{localize('station-name')}}: [[stationItem.name]]</p>
            <p>{{localize('station-number')}}: [[stationItem.number]]</p>
            <p>{{localize('station-machine')}}: [[stationItem.machine]]</p>
            </div>
            <div class="button-group">
            <paper-button raised class="fancy" station="[[stationItem]]" on-tap="editStation">{{localize('edit')}}</paper-button>
            <paper-button raised class="chilli" station="[[stationItem]]" on-tap="removeStation">{{localize('remove')}}</paper-button>
            </div>
            <paper-dialog id="edit_[[stationItem.$key]]" class="station-dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" always-on-top no-cancel-on-outside-click>
            <h2>{{localize('edit-station')}}</h2>
            <paper-input type="text" id="name_[[stationItem.$key]]" name="station-name" class="editstationName" value="[[stationItem.name]]" label="{{localize('station-name')}}" required always-float-label></paper-input>
            <paper-input type="number" id="number_[[stationItem.$key]]" name="station-number" class="editstationNumber" value="[[stationItem.number]]" label="{{localize('station-number')}}" min="1" max="99" step="1" required always-float-label></paper-input>
            <div class="buttons">
                <paper-button station="[[stationItem]]" dialog-dismiss>{{localize('dismiss')}}</paper-button>
                <paper-button station="[[stationItem]]" on-tap="saveEditStation" dialog-confirm autofocus>{{localize('save')}}</paper-button>
            </div>
            </paper-dialog>
          </div>
        </li>
      </template>
    </ul>
  <paper-toast id="toastAddStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-add-station')}}"></paper-toast>
  <paper-toast id="toastSaveStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-save-station')}}"></paper-toast>
  <paper-toast id="toastDeleteStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-delete-station')}}"></paper-toast>
  <paper-toast id="toastEmptyAddStation" role="alert" always-on-top horizontal-align="right" text="{{localize('notification-empty-add-station')}}"></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'view-setup-station',
      properties: {
        language: {
          type: Object,
          value: function () {
            if(localStorage.getItem("lang") != null) {
              return localStorage.getItem("lang");
            } 
            else if(localStorage.getItem("lang") == null) {
              return "en";
            } 
            else {
              return this.language;
            }
          }
        },
        stationItems: {
          type: Object
        },
        notification: {
          type: Object
        }
      },
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      attached: function() {
         this.loadResources(this.resolveUrl('../../data/locales.json'));
      },
      toggleDialog() {
        this.$.createStationDialog.open();
      },
      getStationNumber(length) {
        if(length == 0) {
          return 1;
        } else {
          return length+1;
        }
      },
      addStation() {
        let sname = this.$.stationName.value;
        let snumber = this.$.stationNumber.value;
        if(sname !== "" && snumber !== "") {
        this.$.stationQuery.ref.push({
          name : sname,
          number : snumber
        });
        this.clearField();
           this.$.toastAddStation.open(); 
        } else {
          this.$.toastEmptyAddStation.open();
        }
      },
      editStation(e) {
        let key = e.currentTarget.station.$key;
        this.$$('#edit_'+ key).open();  
      },
      removeStation(e) {
        let key = e.currentTarget.station.$key;
        this.$.stationQuery.ref.child(key).remove();
        if(this.notification) {
        this.$.toastDeleteStation.open(); 
         }
      },
      saveEditStation(e) {
        let key = e.currentTarget.station.$key;
        let sname = this.$$('#name_' + key).value;
        let snumber = this.$$('#number_' + key).value;
        if(sname !== "" && snumber !== "") {
         this.$.stationQuery.ref.child(key).set({
            name: sname,
            number: snumber
        });
           this.$$('.station-dialog').close();
           this.$.toastSaveStation.open();
         } else {
            this.$.toastEmptyAddStation.open();
        }
      },
      dismissEditStation(e) {
        let key = e.currentTarget.station.$key;
      },
      dismissAddStation() {
        this.clearField();
        this.$.createStationDialog.cancel();
      },
      clearField() {
        this.$.stationName.value = "";
        this.$.stationNumber.value = this.stationItems.length + 1;
      },
    });
  </script>
</dom-module>